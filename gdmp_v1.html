<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Streamer | Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- FAVICON: Using a musical note emoji (🎵) as an SVG data URI -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎵</text></svg>">

    <!-- Load Google Platform Libraries for Identity and API Client -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #8b5cf6;
            --dark-bg: #1f2937;
            --card-bg: #374151;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #f3f4f6;
            min-height: 100vh;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        /* Custom Scrollbar for better aesthetics */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--secondary);
            border-radius: 4px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: var(--card-bg);
        }
    </style>

    <!-- API INITIALIZATION FUNCTIONS: Must be in the HEAD so they are defined before the async scripts call them -->
    <script>
        // --- GOOGLE DRIVE CONFIGURATION (Constants) ---
        const GOOGLE_CLIENT_ID = '84691269284-0l1nppv3ujnbmh13983o78p4tmb0nr8l.apps.googleusercontent.com'; 
        const CUSTOM_ROOT_FOLDER_NAME = 'Music'; 
        const SCOPE = 'https://www.googleapis.com/auth/drive.readonly';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

        // --- GLOBAL STATE ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        
        // --- DOM Elements (Defined here so callbacks can access them) ---
        let authButton;
        let authStatusEl;

        // --- GOOGLE API INITIALIZATION CALLBACKS ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            // Wait for the DOM to load before accessing elements
            await new Promise(resolve => {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', resolve);
                } else {
                    resolve();
                }
            });

            // Initialize DOM elements after DOM content is loaded
            authButton = document.getElementById('authButton');
            authStatusEl = document.getElementById('authStatus');

            await gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeInitApp();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPE,
                callback: (tokenResponse) => {
                    // This initial callback is only set up during the GIS client initialization
                },
            });
            gisInited = true;
            maybeInitApp();
        }

        /**
         * Checks if both API libraries are loaded and the Client ID is set.
         * Enables the auth button if all is ready.
         */
        function maybeInitApp() {
            if (gapiInited && gisInited) {
                console.log("--- GOOGLE API STATUS ---");
                console.log("APIs Loaded: OK");
                console.log("App Origin (MUST BE AUTHORIZED):", location.origin);

                // Only enable the button if the client ID check passes
                if (checkClientId()) {
                    authButton.disabled = false;
                    authButton.classList.remove('bg-gray-500'); // Remove potential disabled style
                    authStatusEl.innerHTML = '<span class="text-yellow-400">Ready to Connect</span>';
                } else {
                    // Client ID check failed, keep button disabled and show error
                    authButton.disabled = true;
                }
            } else {
                // Keep button disabled while scripts are loading
                authButton.disabled = true;
                if (authStatusEl) {
                    authStatusEl.innerHTML = '<span class="text-yellow-400">Loading APIs...</span>'; 
                }
            }
        }

        /**
         * Checks if the Client ID is the placeholder value.
         * @returns {boolean} True if client ID is NOT the placeholder.
         */
        function checkClientId() {
            if (GOOGLE_CLIENT_ID.includes('YOUR_GOOGLE_CLIENT_ID_HERE')) {
                if (authStatusEl) {
                    authStatusEl.innerHTML = '<span class="text-red-500 font-bold">SETUP ERROR: Insert Client ID!</span>';
                }
                if (authButton) {
                    authButton.disabled = true;
                }
                return false;
            } 
            return true;
        }
    </script>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start">

    <div id="app" class="w-full max-w-4xl bg-gray-800 shadow-2xl rounded-xl p-4 sm:p-6 space-y-6">

        <!-- Header and Auth Status -->
        <header class="flex flex-col sm:flex-row justify-between items-center border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-white tracking-tight">Cloud Music Library</h1>
            <div id="authStatus" class="mt-2 sm:mt-0 text-sm font-medium">
                <span class="text-yellow-400">Not Connected</span>
            </div>
        </header>

        <!-- Current Player Panel -->
        <div class="bg-gray-700 p-5 rounded-lg shadow-inner flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6">
            <div class="w-20 h-20 bg-gray-600 rounded-lg flex items-center justify-center flex-shrink-0 text-white font-bold text-xl">
                <!-- Placeholder for Album Art -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.5l-10.5 3.5m0 0a3 3 0 110-6 3 3 0 010 6zm10.5 0a3 3 0 110-6 3 3 0 010 6z" />
                </svg>
            </div>
            <div class="flex-grow text-center sm:text-left min-w-0">
                <p id="currentTitle" class="text-xl font-semibold truncate text-white">Select a track to play</p>
                <p id="currentArtist" class="text-sm text-gray-400">Offline</p>
            </div>
            
            <!-- Hidden HTML Audio Element -->
            <audio id="audioPlayer" controls class="w-full sm:w-auto mt-4 sm:mt-0 rounded-lg shadow-lg"></audio>
        </div>

        <!-- Library and Playlist Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Library (File Browser) -->
            <div class="bg-gray-700 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-3 text-white">Google Drive Files (Library)</h2>
                
                <!-- Authentication Button: DISABLED by default until scripts load -->
                <button id="authButton" onclick="handleAuthClick()" class="w-full mb-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white font-medium transition duration-150" disabled>
                    Sign in to Google Drive
                </button>
                <button id="signoutButton" onclick="handleSignoutClick()" class="w-full mb-3 py-2 bg-red-600 hover:bg-red-700 rounded-md text-white font-medium transition duration-150 hidden">
                    Sign Out
                </button>

                <!-- Navigation Panel -->
                <div id="navigationPanel" class="mb-3">
                    <!-- Navigation content will be dynamically updated here -->
                </div>

                <div id="fileList" class="scroll-container border border-gray-600 rounded-md divide-y divide-gray-600">
                    <p class="p-3 text-gray-400 text-sm">Sign in to load your music library.</p>
                </div>
            </div>

            <!-- Current Playlist -->
            <div class="bg-gray-700 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-3 text-white">Current Playlist</h2>
                <div id="playlist" class="scroll-container border border-gray-600 rounded-md divide-y divide-gray-600">
                    <p class="p-3 text-gray-400 text-sm">Add tracks from the library to build your playlist.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- MANDATORY GLOBALS (STUBS) ---
        // These are typically provided by the hosting environment but kept for completeness
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- DRIVE STATE ---
        let accessToken = null;
        let currentFolderId = 'root'; // Start at the root of My Drive initially
        let currentPlaylist = [];
        let currentTrackIndex = -1;
        let currentBlobUrl = null; // Variable to hold the URL object for cleanup

        // --- DOM ELEMENTS (Access them globally here for convenience) ---
        const audioPlayer = document.getElementById('audioPlayer');
        const fileListContainer = document.getElementById('fileList');
        const playlistContainer = document.getElementById('playlist');
        const currentTitleEl = document.getElementById('currentTitle');
        const currentArtistEl = document.getElementById('currentArtist');
        const signoutButton = document.getElementById('signoutButton');
        const navigationPanel = document.getElementById('navigationPanel');

        // --- AUTHENTICATION HANDLERS ---

        /**
         * Searches for a specified folder name in the root of the user's drive.
         * @param {string} folderName The name of the folder to search for.
         * @returns {string | null} The ID of the found folder, or null.
         */
        async function findRootFolder(folderName) {
 //           const query = `name = '${folderName}' and mimeType = 'application/vnd.google-apps.folder' and 'root' in parents and trashed = false`;
            const query = `name = '${folderName}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`;
            try {
                const response = await gapi.client.drive.files.list({
                    q: query,
                    fields: 'files(id)',
                    pageSize: 1
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    console.log(`Found custom root folder: ${folderName}`);
                    return files[0].id;
                }
                return null;
            } catch (error) {
                console.error("Error searching for root folder:", error);
                return null;
            }
        }

        async function updateAuthStatus(isSignedIn) {
            if (isSignedIn) {
                authStatusEl.innerHTML = '<span class="text-green-400">Connected to Drive</span>';
                authButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');

                let startFolderId = 'root';
                if (CUSTOM_ROOT_FOLDER_NAME) {
                    fileListContainer.innerHTML = `<p class="p-3 text-indigo-400 text-sm">Searching for custom root: "${CUSTOM_ROOT_FOLDER_NAME}"...</p>`;
                    const customId = await findRootFolder(CUSTOM_ROOT_FOLDER_NAME);
                    if (customId) {
                        startFolderId = customId;
                    } else {
                        authStatusEl.innerHTML = `<span class="text-yellow-400">Note: Folder "${CUSTOM_ROOT_FOLDER_NAME}" not found. Starting at My Drive root.</span>`;
                    }
                }
                
                // Set the determined start folder and list files
                currentFolderId = startFolderId;
                listDriveFiles(currentFolderId); 

            } else {
                authStatusEl.innerHTML = '<span class="text-yellow-400">Not Connected</span>';
                authButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                fileListContainer.innerHTML = '<p class="p-3 text-gray-400 text-sm">Sign in to load your music library.</p>';
                navigationPanel.innerHTML = '';
                currentFolderId = 'root';
                currentPlaylist = [];
                currentTrackIndex = -1;
                renderPlaylist();
                audioPlayer.pause();
                audioPlayer.src = '';
                currentTitleEl.textContent = 'Select a track to play';
                currentArtistEl.textContent = 'Offline';
                
                maybeInitApp();
            }
        }

        function handleAuthClick() {
            if (!tokenClient) {
                console.error("GIS client not initialized. Cannot proceed.");
                authStatusEl.innerHTML = '<span class="text-red-400">Error: API client not loaded. Try refreshing.</span>';
                return;
            }
            tokenClient.callback = async (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    accessToken = tokenResponse.access_token;
                    gapi.client.setToken({ access_token: accessToken });
                    updateAuthStatus(true);
                } else {
                    console.error("Failed to get access token:", tokenResponse);
                    authStatusEl.innerHTML = '<span class="text-red-400">Authentication Failed! Check Client ID & Origin in Cloud Console.</span>';
                }
            };
            tokenClient.requestAccessToken();
        }

        function handleSignoutClick() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Access token revoked.');
                    accessToken = null;
                    gapi.client.setToken(null);
                    updateAuthStatus(false);
                });
            } else {
                updateAuthStatus(false);
            }
        }

        // --- DRIVE NAVIGATION & API FUNCTIONS ---

        /**
         * Changes the current folder and reloads the file list.
         * @param {string} folderId The ID of the folder to open.
         */
        function openFolder(folderId) {
            currentFolderId = folderId;
            listDriveFiles(folderId);
        }

        /**
         * Navigates back to the root of the library (My Drive).
         * Note: Full parent traversal is complex; this returns to root for simplicity.
         */
        function goToRoot() {
            openFolder('root');
        }


        /**
         * Fetches audio files AND folders from the current Google Drive location.
         * @param {string} parentId The ID of the folder to search within.
         */
        async function listDriveFiles(parentId = currentFolderId) {
            fileListContainer.innerHTML = '<p class="p-3 text-indigo-400 text-sm">Loading files and folders...</p>';
            
            // Query for files that are children of parentId AND are either audio or a folder
            const query = `'${parentId}' in parents and (mimeType contains 'audio/' or mimeType = 'application/vnd.google-apps.folder') and trashed = false`;

            try {
                const response = await gapi.client.drive.files.list({
                    q: query, 
                    pageSize: 100,
                    fields: 'nextPageToken, files(id, name, mimeType, parents)',
                    // FIX: Changed sorting to use 'folder' which is a supported property, 
                    // fixing the 400 'Invalid Value' error on 'orderBy'.
                    orderBy: 'folder, name',
                });

                const files = response.result.files || [];
                
                if (files.length > 0) {
                    renderFileList(files);
                } else {
                    fileListContainer.innerHTML = '<p class="p-3 text-gray-400 text-sm">This folder is empty or contains no music/folders.</p>';
                }

                renderNavigation(parentId); // Update the navigation UI after loading

            } catch (error) {
                let errorMessage = "Unknown API Error. See console for full details.";
                if (error.result && error.result.error && error.result.error.message) {
                    // Extract the human-readable error from the Google API response
                    errorMessage = error.result.error.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }

                console.error("Error listing files:", error);
                fileListContainer.innerHTML = '<p class="p-3 text-red-400 text-sm">Error loading files. Check console for API details.</p>';
                // Display the specific API error in the status bar for visibility
                authStatusEl.innerHTML = `<span class="text-red-400">API Query Failed: ${errorMessage}</span>`;
            }
        }

        // --- PLAYER LOGIC ---
        
        /**
         * Uses the Fetch API with the access token to securely retrieve the audio file as a blob 
         */
        async function fetchAndPlayTrack(track, trackIndex) {
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }

            currentTrackIndex = trackIndex;
            
            renderPlaylist();

            currentTitleEl.textContent = track.name.replace(/\.(mp3|flac|wav|ogg)$/i, '');
            currentArtistEl.textContent = track.artist || 'Unknown Artist';
            
            fileListContainer.innerHTML = '<p class="p-3 text-indigo-400 text-sm">Streaming track data...</p>';

            const streamUrl = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`;

            try {
                const response = await fetch(streamUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. Check Network tab.`);
                }

                const blob = await response.blob();
                currentBlobUrl = URL.createObjectURL(blob);
                
                audioPlayer.src = currentBlobUrl;
                audioPlayer.load(); 
                
                audioPlayer.play().catch(error => {
                    console.error("Autoplay failed. Please click play manually.", error);
                    authStatusEl.innerHTML = '<span class="text-red-400">Autoplay blocked. Click play on the audio bar.</span>';
                });

                listDriveFiles(currentFolderId); 

            } catch (error) {
                console.error("Failed to stream audio:", error);
                authStatusEl.innerHTML = `<span class="text-red-400">Stream Error: ${error.message}</span>`;
                audioPlayer.pause();
                audioPlayer.src = '';
                listDriveFiles(currentFolderId); 
            }
        }


        function playTrack(trackIndex) {
            if (trackIndex < 0 || trackIndex >= currentPlaylist.length) return;
            if (!accessToken) {
                authStatusEl.innerHTML = '<span class="text-red-400">Sign in required to play!</span>';
                console.warn("User is not signed in to stream music.");
                return;
            }
            
            const track = currentPlaylist[trackIndex];
            fetchAndPlayTrack(track, trackIndex);
        }

        function playNextTrack() {
            if (currentPlaylist.length === 0) return;
            const nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
            playTrack(nextIndex);
        }

        audioPlayer.addEventListener('ended', playNextTrack);

        // --- UI RENDERING ---

        /**
         * Renders the navigation controls (e.g., Back button).
         * For simplicity, we only allow going back to the root 'My Drive' view.
         */
        function renderNavigation(parentId) {
            navigationPanel.innerHTML = '';
            // If the current folder is not the ultimate 'root', show the back button.
            if (parentId !== 'root' && parentId !== (CUSTOM_ROOT_FOLDER_NAME && currentFolderId)) {
                const backButton = document.createElement('button');
                backButton.className = 'flex items-center text-sm font-medium text-indigo-400 hover:text-indigo-300 transition duration-150 mb-3';
                backButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                    Back to My Drive Root
                `;
                backButton.onclick = goToRoot; 
                navigationPanel.appendChild(backButton);
            }
        }


        function renderFileList(files) {
            fileListContainer.innerHTML = ''; // Clear previous list
            files.forEach(file => {
                const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                const icon = isFolder ? '📁' : (file.art || '🎵');
                const title = file.name.replace(/\.(mp3|flac|wav|ogg)$/i, '');
                
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 hover:bg-gray-600 transition duration-150 cursor-pointer';
                
                if (isFolder) {
                    // Click handler to open the folder
                    item.onclick = () => openFolder(file.id);
                    item.innerHTML = `
                        <div class="flex-1 min-w-0 flex items-center">
                            <span class="text-lg mr-3">${icon}</span>
                            <div class="min-w-0">
                                <p class="text-sm font-medium truncate text-white">${title}</p>
                                <p class="text-xs text-indigo-400">Folder</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Click handler to add to playlist
                    const track = { id: file.id, name: file.name, artist: 'Drive Folder', art: '🎵' };
                    item.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate text-white">${icon} ${title}</p>
                            <p class="text-xs text-gray-400">${track.artist}</p>
                        </div>
                        <button class="text-sm text-green-400 hover:text-green-300 ml-4 p-1 rounded-full hover:bg-gray-500" title="Add to Playlist">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                        </button>
                    `;
                    item.querySelector('button').onclick = () => addToPlaylist(track);
                }
                
                fileListContainer.appendChild(item);
            });
        }

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            if (currentPlaylist.length === 0) {
                 playlistContainer.innerHTML = '<p class="p-3 text-gray-400 text-sm">Add tracks from the library to build your playlist.</p>';
                 return;
            }

            currentPlaylist.forEach((track, index) => {
                const isPlaying = index === currentTrackIndex;
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-3 transition duration-150 cursor-pointer ${isPlaying ? 'bg-indigo-900 border-l-4 border-indigo-400' : 'hover:bg-gray-600'}`;
                
                item.innerHTML = `
                    <div class="flex-1 min-w-0 flex items-center" onclick="playTrack(${index})">
                        <span class="mr-3 text-lg">${isPlaying ? '▶️' : (track.art || '🎵')}</span>
                        <div class="min-w-0">
                            <p class="text-sm font-medium truncate ${isPlaying ? 'text-white' : 'text-gray-200'}">${track.name.replace(/\.(mp3|flac|wav|ogg)$/i, '')}</p>
                            <p class="text-xs ${isPlaying ? 'text-indigo-300' : 'text-gray-400'}">${track.artist || 'Drive Folder'}</p>
                        </div>
                    </div>
                    <button class="text-sm text-red-400 hover:text-red-300 ml-4 p-1 rounded-full hover:bg-gray-500" title="Remove from Playlist" onclick="removeFromPlaylist(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                playlistContainer.appendChild(item);
            });
        }

        function addToPlaylist(file) {
            currentPlaylist.push(file);
            renderPlaylist();
            // Optional: Start playing immediately if the playlist was empty
            if (currentPlaylist.length === 1 && currentTrackIndex === -1) {
                playTrack(0);
            }
        }

        function removeFromPlaylist(index) {
            if (index === currentTrackIndex) {
                audioPlayer.pause();
                currentTitleEl.textContent = 'Select a track to play';
                currentArtistEl.textContent = 'Offline';
                currentTrackIndex = -1;
            }
            
            currentPlaylist.splice(index, 1);

            // Adjust index if the removed track was before the currently playing one
            if (index < currentTrackIndex) {
                currentTrackIndex--;
            } else if (index === currentTrackIndex && currentPlaylist.length > 0) {
                // If we removed the playing track, play the next one
                playTrack(index % currentPlaylist.length);
            }

            renderPlaylist();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check Client ID early
            checkClientId();
            // Initial UI setup (will call maybeInitApp from a safe place later)
            updateAuthStatus(false);
        });
    </script>
</body>
</html>
